# Plan de Implementaci√≥n: Metodolog√≠a Perplexity para An√°lisis de Agencias Automotrices

## üìä An√°lisis de Viabilidad

### ‚úÖ Componentes existentes reutilizables:
- Sistema de agentes modular (ranking, reputation, inventory, insights)
- Infraestructura de an√°lisis con `BaseAnalyzer` y `AnalysisManager`
- Integraci√≥n con Google Maps v√≠a Apify MCP
- Vector storage con Supabase para b√∫squeda sem√°ntica
- Sistema de tipos y arquitectura base

### üîß Componentes a desarrollar:
1. **Query Understanding Engine** - Interpretar consultas automotrices
2. **Hybrid Retrieval System** - Combinar m√∫ltiples fuentes de datos
3. **Neural Reranker** - Modelo para scoring de relevancia
4. **Citation Engine** - Sistema de referencias verificables
5. **Feedback Loop** - Mejora continua basada en m√©tricas

### üéØ MVP Definido (Respuesta 1):
**Diferenciadores clave vs Google Maps/Clasificados:**
- **M√∫ltiples fuentes de datos**: No solo ubicaci√≥n, sino inventario real, precios, reputaci√≥n
- **Scoring inteligente**: Algoritmo que pondera m√∫ltiples factores
- **An√°lisis de rese√±as para FAQs**: Extracci√≥n de insights comunes de las rese√±as
- **Generaci√≥n de contenido**: Respuestas personalizadas y contextualizadas
- **Plataforma confiable**: Citas verificables y transparencia en las recomendaciones

**Implicaciones para el plan:**
- ‚úÖ Todas las fases son necesarias para el MVP
- ‚úÖ El scoring inteligente es cr√≠tico (Fase 3)
- ‚úÖ El an√°lisis de rese√±as debe ser profundo (Fase 2)
- ‚úÖ Las citaciones son esenciales para confiabilidad (Fase 4)

### üìä Fuentes de Datos Disponibles (Respuesta 2 - ACTUALIZADA):
**Recursos confirmados:**
- ‚úÖ Google Places API (informaci√≥n b√°sica de agencias, pero solo 5 reviews m√°ximo)
- ‚úÖ Apify Google Maps Reviews Scraper (puede obtener miles de reviews)
- ‚úÖ Perplexity API (an√°lisis inteligente y comprensi√≥n de contexto)

**Limitaciones importantes:**
- ‚ö†Ô∏è Google Places API: Solo devuelve 5 reviews (limitaci√≥n hardcoded)
- ‚ö†Ô∏è Google My Business API: Solo para negocios propios, requiere 2-4 semanas aprobaci√≥n
- ‚ùå Sin APIs de inventario directo
- ‚ùå Sin base de datos propia de agencias

**Soluci√≥n adoptada:**
- Usar Apify's "Google Maps Reviews Scraper" para obtener reviews completas
- Complementar con Google Places API para datos b√°sicos
- Perplexity API para an√°lisis profundo

**Estrategia adaptada:**
1. **Fase inicial**: Maximizar valor con datos p√∫blicos disponibles
2. **Perplexity como motor de an√°lisis**: Usar para an√°lisis profundos, encontrar URLs de inventario, redes sociales, etc.
3. **Construcci√≥n incremental**: Comenzar con datos p√∫blicos, agregar fuentes conforme crezca la base de usuarios
4. **Foco en insights**: Generar valor agregado del an√°lisis profundo de datos p√∫blicos

### üß† Estrategia de Scoring/Ranking (Respuesta 3):
**Recursos disponibles:**
- ‚úÖ OpenRouter API (LLMs para an√°lisis)
- ‚úÖ Perplexity API (¬°Gran oportunidad para simplificar!)
- ‚úÖ Todo en cloud (sin limitaciones de infraestructura local)
- ‚úÖ Hugging Face disponible si es necesario

**Estrategia MVP adaptada:**
1. **MVP inicial**: Scoring basado en reglas ponderadas
   - Distancia (30%)
   - Rating de Google (25%)
   - An√°lisis de sentimiento de rese√±as (25%)
   - Frecuencia de menciones positivas (20%)

2. **Uso de Perplexity API**: 
   - Simplificar la b√∫squeda multi-fuente
   - Aprovechar su RAG pre-construido
   - Reducir complejidad de implementaci√≥n

3. **Evoluci√≥n futura**: Migrar a modelos m√°s sofisticados cuando tengamos m√©tricas de usuario

### üîç Tipos de Consultas Esperadas (Respuesta 4):
**Queries identificadas:**
1. **Por precio**: "autos baratos", "menos de 200k"
2. **Marca + Modelo + A√±o**: "Toyota Camry 2022"
3. **Con financiamiento**: "Honda Civic a cr√©dito"
4. **Por caracter√≠sticas**: "SUV barato", "autos m√°s seguros"
5. **Combinadas**: "Toyota h√≠brido con financiamiento"

**Estrategia de Query Understanding:**
1. **Parser de reglas**: Detectar patrones comunes (marca/modelo/a√±o/precio)
2. **Sin filtro por marca**: Si buscan "Toyota Camry", incluir TODAS las agencias confiables, no solo Toyota
3. **Fallback inteligente**: Si no matchea reglas ‚Üí Perplexity API para interpretaci√≥n
4. **Categorizaci√≥n din√°mica**: 
   - B√∫squeda por producto (marca/modelo) - pero sin excluir agencias
   - B√∫squeda por necesidad (seguro, familiar, econ√≥mico)
   - B√∫squeda por capacidad financiera (cr√©dito, contado)

### üéØ Propuesta de Valor √önica (Respuesta 5):
**Karmatic: El asistente inteligente del comprador de autos en M√©xico**

**Diferenciadores clave:**
1. **Todo en un lugar**: Informaci√≥n completa de agencias + inventario + rese√±as + precios
2. **Especializaci√≥n automotriz**: No es un AI gen√©rico, entiende el contexto mexicano
3. **Del lado del usuario**: Informaci√≥n curada y confiable, sin sesgos de vendedores
4. **Anti-fraude**: Verificaci√≥n de informaci√≥n y transparencia total
5. **Decisiones informadas**: No solo "d√≥nde" sino tambi√©n "qu√©" auto comprar

**Problemas que resuelve:**
- ‚ùå Clasificados tradicionales ‚Üí ‚úÖ Plataforma inteligente con an√°lisis
- ‚ùå Informaci√≥n dispersa ‚Üí ‚úÖ Agregaci√≥n unificada
- ‚ùå Riesgo de fraude ‚Üí ‚úÖ Verificaci√≥n y citaciones
- ‚ùå Complejidad de decisi√≥n ‚Üí ‚úÖ Recomendaciones personalizadas
- ‚ùå Falta de confianza ‚Üí ‚úÖ Transparencia total

**Beneficio dual:**
- **Usuarios**: Encuentran el auto ideal en la agencia correcta
- **Agencias**: Reciben feedback para mejorar y atraer m√°s clientes

### üìà M√©tricas de √âxito (Respuesta 6):
**KPI Principal:**
- **Conversi√≥n a plan pago**: % de usuarios free que se convierten a premium

**M√©tricas secundarias para optimizar conversi√≥n:**
1. **Engagement**:
   - Queries por usuario
   - Tiempo en la plataforma
   - Retenci√≥n (usuarios que regresan)

2. **Valor percibido**:
   - Calidad de respuestas (feedback directo)
   - Agencias contactadas desde la app
   - Compartir resultados

3. **Limitaciones estrat√©gicas del plan free**:
   - N√∫mero de consultas por d√≠a/mes
   - Profundidad del an√°lisis
   - Acceso a features premium (comparaciones avanzadas, alertas)

**Implicaci√≥n para el MVP:**
- Dise√±ar desde el inicio qu√© features son free vs premium
- Sistema de tracking robusto para entender qu√© impulsa conversiones
- A/B testing de l√≠mites y features

### üèóÔ∏è Estrategia de Desarrollo (Respuesta 7):
**Decisi√≥n: Comenzar desde cero**
- ‚úÖ Oportunidad de dise√±ar arquitectura √≥ptima desde el inicio
- ‚úÖ Alineaci√≥n total con metodolog√≠a Perplexity
- ‚úÖ Sin deuda t√©cnica heredada
- ‚úÖ Enfoque en features que impulsen conversi√≥n a pago

**Ventajas de empezar fresh:**
1. Arquitectura moderna y escalable
2. Integraci√≥n nativa con Perplexity API
3. Dise√±o orientado a m√©tricas desde el d√≠a 1
4. Pipeline optimizado para el caso de uso mexicano

### ‚ö° Estrategia de Performance (Respuesta 8):
**Decisi√≥n: Todo en tiempo real por costos**
- ‚úÖ Sin gastos en pre-c√≥mputo de agencias no consultadas
- ‚úÖ Pago solo por uso real
- ‚úÖ Flexibilidad total en los datos

**Optimizaciones de latencia sin pre-c√≥mputo:**
1. **Cache inteligente**:
   - Cache de interpretaciones de queries (Redis)
   - Cache de resultados por ubicaci√≥n + query (TTL: 1 hora)
   - Cache de an√°lisis de rese√±as (TTL: 24 horas)

2. **Paralelizaci√≥n agresiva**:
   - Todas las APIs llamadas en paralelo
   - Timeout estricto de 3s por fuente
   - Respuesta parcial si alguna fuente falla

3. **Progressive disclosure**:
   - Mostrar resultados b√°sicos inmediato (< 2s)
   - Enriquecer con an√°lisis profundo mientras carga
   - Usuario ve progreso = percepci√≥n de velocidad

**Target de latencia: 3-5s para respuesta completa**

### üóÑÔ∏è Estrategia de Datos (Respuesta 9):
**Decisi√≥n: 100% din√°mico**
- ‚úÖ Sin mantenimiento de base de datos inicial
- ‚úÖ Descubrimiento org√°nico basado en b√∫squedas reales
- ‚úÖ Cero costo de almacenamiento inicial
- ‚úÖ Datos siempre frescos de Google Places

**Implicaciones:**
1. **Bootstrap m√≠nimo**: Solo l√≥gica, sin datos
2. **Aprendizaje org√°nico**: El sistema descubre agencias conforme los usuarios buscan
3. **Cache como BD temporal**: Redis almacena agencias consultadas
4. **Escalamiento natural**: La "base de datos" crece con el uso

### üá≤üáΩ Contexto del Mercado Mexicano (Respuesta 10):
**Problema principal: FRAUDE y falta de transparencia**

**Foco del an√°lisis:**
1. **Reputaci√≥n sobre tipo**: No importa si es agencia oficial o lote, sino su √©tica
2. **Transparencia**: C√≥mo manejan problemas y errores
3. **Responsabilidad**: Apoyo post-venta y resoluci√≥n de conflictos
4. **Verificaci√≥n cruzada**: Rese√±as + noticias + redes sociales + YouTube

**Se√±ales de confianza a detectar:**
- ‚úÖ Respuestas a rese√±as negativas (muestra responsabilidad)
- ‚úÖ Resoluci√≥n de problemas documentada
- ‚úÖ Transparencia en precios y condiciones
- ‚úÖ Menciones positivas en redes sociales
- ‚ùå Patrones de quejas sin resolver
- ‚ùå Cambios frecuentes de nombre/raz√≥n social
- ‚ùå Discrepancias entre lo anunciado y lo real

**T√©rminos mexicanos clave:**
- Enganche, mensualidades, de contado
- "A cambio" (trade-in)
- Seminuevos, certificados
- "Factura original", "libre de gravamen"

**Estrategia: Usar Perplexity API para entender contexto cultural**

## üìã Plan de Implementaci√≥n por Fases

### Fase 1: Query Understanding (1-2 d√≠as)

**Estructura de archivos:**
```
üìÅ src/mastra/analysis/query/
‚îú‚îÄ‚îÄ parser.ts          # Parseo de consultas automotrices
‚îú‚îÄ‚îÄ entities.ts        # Extracci√≥n de marca, modelo, a√±o
‚îú‚îÄ‚îÄ intent.ts          # Clasificaci√≥n de intenci√≥n
‚îî‚îÄ‚îÄ context.ts         # An√°lisis contextual
```

**Tareas:**
- [ ] Implementar parser de reglas para patrones comunes
- [ ] Integrar Perplexity API como fallback para queries complejas
- [ ] Crear extractores de: marca, modelo, a√±o, precio, financiamiento
- [ ] Sistema de cache para interpretaciones exitosas

**Ejemplos de implementaci√≥n:**
```typescript
// Caso 1: Query simple con reglas
Input: "Toyota Camry 2022 barato"
Output: {
  m√©todo: "reglas",
  intenci√≥n: "compra_vehiculo",
  entidades: {
    marca: "Toyota",
    modelo: "Camry",
    a√±o: 2022,
    precio: "econ√≥mico"
  }
}

// Caso 2: Query compleja con Perplexity
Input: "autos m√°s seguros para familia con buen financiamiento"
Output: {
  m√©todo: "perplexity_api",
  intenci√≥n: "compra_vehiculo_seguro",
  entidades: {
    caracter√≠sticas: ["seguridad", "familiar"],
    servicios: ["financiamiento"],
    interpretaci√≥n: "Usuario busca veh√≠culos con alto rating de seguridad, 
                     espacio familiar (SUV/Minivan), con opciones de cr√©dito"
  }
}
```

### Fase 2: Hybrid Retrieval System (2-3 d√≠as)

**Estructura de archivos:**
```
üìÅ src/mastra/analysis/retrieval/
‚îú‚îÄ‚îÄ sources/
‚îÇ   ‚îú‚îÄ‚îÄ places.ts      # Google Places via Apify
‚îÇ   ‚îú‚îÄ‚îÄ inventory.ts   # Web scraping dealerships
‚îÇ   ‚îú‚îÄ‚îÄ reviews.ts     # Rese√±as m√∫ltiples fuentes
‚îÇ   ‚îî‚îÄ‚îÄ pricing.ts     # Comparaci√≥n de precios
‚îú‚îÄ‚îÄ fusion/
‚îÇ   ‚îú‚îÄ‚îÄ vector.ts      # B√∫squeda vectorial
‚îÇ   ‚îî‚îÄ‚îÄ hybrid.ts      # Combinaci√≥n vector+keyword
‚îî‚îÄ‚îÄ orchestrator.ts    # Coordinador paralelo
```

**Agentes de B√∫squeda Paralelos:**

| Agente | Funci√≥n | Fuente de Datos | Tiempo de Respuesta |
|--------|---------|----------------|-------------------|
| **Places Agent** | Encuentra agencias cercanas | Google Places API ‚úÖ | 200-400ms |
| **Reviews Scraper** | Recopila TODAS las rese√±as (100s-1000s) | Apify Google Maps Reviews Scraper ‚úÖ | 3-5s |
| **Trust Analyzer** | Detecta patrones de fraude y confiabilidad | An√°lisis de rese√±as completas | 1-2s |
| **FAQ Generator** | Extrae insights y preguntas frecuentes | NLP sobre rese√±as completas | 1-2s |
| **Reputation Scorer** | Calcula score de confianza | An√°lisis multi-factor de reviews | 500ms |

**Tareas:**
- [ ] Adaptar agentes existentes al nuevo sistema de retrieval
- [ ] Implementar b√∫squeda paralela con timeout management
- [ ] Crear sistema de fusi√≥n h√≠brida (vectorial + geoespacial)
- [ ] Desarrollar diversity sampling para evitar sesgo

### Fase 3: Scoring Inteligente (1 d√≠a) - SIMPLIFICADO

**Estructura de archivos:**
```
üìÅ src/mastra/analysis/ranking/
‚îú‚îÄ‚îÄ scorer.ts          # Scoring multi-criterio
‚îú‚îÄ‚îÄ weights.ts         # Pesos configurables
‚îú‚îÄ‚îÄ filters.ts         # Filtros de calidad
‚îî‚îÄ‚îÄ ranker.ts          # L√≥gica de ranking final
```

**Tareas:**
- [ ] Implementar scoring basado en reglas ponderadas
- [ ] Sistema de pesos configurables para ajuste r√°pido
- [ ] Filtros de calidad m√≠nima (rating > 3.5, rese√±as > 10)
- [ ] Normalizaci√≥n de scores para comparaci√≥n justa

**Pipeline de Scoring Simplificado:**
1. Recuperaci√≥n inicial: ~20-30 agencias cercanas
2. C√°lculo de score compuesto:
   - Proximidad: (1 - distancia/radio_max) √ó 0.30
   - Rating: (rating/5) √ó 0.25
   - Sentimiento: score_sentimiento √ó 0.25
   - Menciones: score_menciones √ó 0.20
3. Filtrado: Agencias con score total >0.60
4. Top 10 ordenadas por score

### Fase 4: RAG Pipeline & Citations (2 d√≠as)

**Estructura de archivos:**
```
üìÅ src/mastra/analysis/rag/
‚îú‚îÄ‚îÄ context/
‚îÇ   ‚îú‚îÄ‚îÄ builder.ts     # Construcci√≥n de contexto
‚îÇ   ‚îú‚îÄ‚îÄ enricher.ts    # Enriquecimiento con metadata
‚îÇ   ‚îî‚îÄ‚îÄ compressor.ts  # Compresi√≥n para LLM window
‚îú‚îÄ‚îÄ generation/
‚îÇ   ‚îú‚îÄ‚îÄ router.ts      # Selector de modelo
‚îÇ   ‚îî‚îÄ‚îÄ generator.ts   # Generaci√≥n de respuestas
‚îî‚îÄ‚îÄ citations/
    ‚îú‚îÄ‚îÄ tracker.ts     # Tracking de fuentes
    ‚îî‚îÄ‚îÄ formatter.ts   # Formato de referencias
```

**Tareas:**
- [ ] Implementar construcci√≥n de contexto fusionado
- [ ] Crear router din√°mico de modelos (Sonar, GPT-4, Claude)
- [ ] Desarrollar sistema de citaciones num√©ricas
- [ ] Implementar verificaci√≥n de fuentes

**Procesamiento RAG de Tres Etapas:**

**Etapa 1: Recuperaci√≥n Gruesa (Coarse Retrieval)**
- B√∫squeda inicial en un radio de 3000 metros usando PostGIS
- Filtrado por tipo de negocio (car_dealer) y status operativo
- Recuperaci√≥n de ~50 agencias candidatas con diversidad sampling

**Etapa 2: Reranking Neural**
- Modelo cross-encoder (DeBERTa-v3) para calcular relevancia
- Puntuaci√≥n basada en: proximidad, inventario match, rating, servicios
- Filtrado de agencias con score <70% de relevancia

**Etapa 3: Fusi√≥n Contextual y Generaci√≥n**
- T5 para fusionar fragmentos relevantes en contexto coherente
- Enriquecimiento con metadata: horarios, servicios, promociones
- Router RL selecciona LLM √≥ptimo seg√∫n complejidad y latencia

### Fase 5: Feedback Loop & Optimization (1-2 d√≠as)

**Estructura de archivos:**
```
üìÅ src/mastra/analysis/feedback/
‚îú‚îÄ‚îÄ collectors/
‚îÇ   ‚îú‚îÄ‚îÄ clicks.ts      # Click tracking
‚îÇ   ‚îú‚îÄ‚îÄ ratings.ts     # User ratings
‚îÇ   ‚îî‚îÄ‚îÄ conversions.ts # Conversion tracking
‚îî‚îÄ‚îÄ optimization/
    ‚îú‚îÄ‚îÄ ranker.ts      # Ajuste de ranking
    ‚îî‚îÄ‚îÄ prompts.ts     # Mejora de prompts
```

**Tareas:**
- [ ] Implementar recolecci√≥n de m√©tricas de usuario
- [ ] Crear sistema de ajuste de pesos en tiempo real
- [ ] Desarrollar A/B testing para optimizaci√≥n
- [ ] Implementar cache inteligente con Redis

## üîÑ Integraci√≥n con Sistema Actual

```typescript
// Ejemplo de integraci√≥n con la arquitectura existente
export class PerplexityAnalyzer extends BaseAnalyzer {
  id = 'perplexity-automotive';
  name = 'Perplexity-style Automotive Analyzer';
  description = 'An√°lisis completo de agencias usando metodolog√≠a Perplexity';
  version = '1.0.0';
  
  filters = [
    {
      id: 'query',
      name: 'Consulta de b√∫squeda',
      type: 'text',
      required: true,
    },
    {
      id: 'radius',
      name: 'Radio de b√∫squeda (km)',
      type: 'numeric',
      defaultValue: 50,
      validation: { min: 1, max: 200 }
    },
    {
      id: 'searchMode',
      name: 'Modo de b√∫squeda',
      type: 'categorical',
      options: ['pro', 'deep'],
      defaultValue: 'pro'
    }
  ];
  
  async analyze(context: AnalysisContext, filters: Record<string, any>) {
    // 1. Query Understanding
    const parsed = await this.parseQuery(filters.query);
    
    // 2. Hybrid Retrieval
    const sources = await this.retrieveParallel(parsed, context.agency.location);
    
    // 3. Neural Reranking
    const ranked = await this.rerank(sources, parsed.intent);
    
    // 4. Context Fusion & Generation
    const response = await this.generateWithCitations(ranked);
    
    // 5. Track Feedback
    await this.trackInteraction(response);
    
    return {
      id: `perplexity-${Date.now()}`,
      agencyId: context.agency.id,
      type: this.id,
      timestamp: new Date(),
      data: response,
      score: response.confidence,
      confidence: response.confidence
    };
  }
}
```

## üìä M√©tricas de √âxito Ajustadas al Contexto Mexicano

| M√©trica | Objetivo | Medici√≥n |
|---------|----------|----------|
| Detecci√≥n de fraude | 90% precisi√≥n en identificar agencias problem√°ticas | Validaci√≥n con casos reportados |
| Confiabilidad del scoring | Score correlaciona con satisfacci√≥n real | Feedback post-compra |
| Conversi√≥n a pago | >5% free-to-paid | Tracking de suscripciones |
| Retenci√≥n | >60% usuarios regresan | Analytics de uso |
| Valor percibido | >4.5/5 en utilidad para evitar fraudes | Encuestas |

## ‚ö†Ô∏è Consideraciones T√©cnicas

1. **Escalabilidad**: 
   - Usar workers para b√∫squedas paralelas
   - Implementar queue management con Bull/BullMQ
   - Load balancing entre m√∫ltiples instancias

2. **Costos**: 
   - Implementar cache agresivo para reducir API calls
   - Batch processing donde sea posible
   - Rate limiting inteligente

3. **Legal**: 
   - Respetar robots.txt y t√©rminos de servicio
   - Implementar user-agent apropiado
   - Cumplir con regulaciones de datos

4. **Performance**: 
   - Lazy loading de modelos neural reranking
   - Streaming de respuestas largas
   - Compresi√≥n de contexto adaptativa

## üöÄ Plan MVP SIMPLIFICADO - "Karmatic: Tu guardi√°n contra fraudes automotrices"

### MVP Fase 1: Core Trust Engine (3-4 d√≠as)
1. **Query Handler Simplificado**
   - Parser b√°sico para marca/modelo/ubicaci√≥n
   - Perplexity API como fallback para queries complejas
2. **Data Pipeline**
   - Google Places API ‚Üí Datos b√°sicos
   - Apify Reviews Scraper ‚Üí Reviews completas (100s-1000s)
   - Cache agresivo en Redis
3. **Trust Score Simple**
   - % rese√±as positivas/negativas
   - Detecci√≥n de palabras clave de fraude
   - Respuestas a quejas (se√±al de responsabilidad)

### MVP Fase 2: Inteligencia y UX (3-4 d√≠as)
1. **Perplexity Integration Avanzada**
   - An√°lisis profundo: "Dame an√°lisis detallado de [Agencia A]"
   - Descubrimiento autom√°tico: URLs inventario, redes sociales, noticias
   - FAQs autom√°ticas desde reviews
   - B√∫squeda de informaci√≥n adicional no disponible en APIs
2. **Sistema de Alertas**
   - üö® Red flags claros en UI
   - ‚úÖ Se√±ales de confianza destacadas
3. **Citaciones y Enlaces**
   - Links a reviews espec√≠ficas
   - Enlaces a inventario descubierto
   - Redes sociales de la agencia

### MVP Fase 3: Monetizaci√≥n B√°sica (2-3 d√≠as)
1. **L√≠mites simples**:
   - Free: 3 b√∫squedas/d√≠a
   - Premium: Ilimitado + alertas avanzadas
2. **Analytics m√≠nimo**
   - Conversi√≥n free‚Üípaid
   - Queries m√°s comunes

### Diferenciador clave redefinido:
**"No solo te decimos d√≥nde comprar, te protegemos de d√≥nde NO comprar"**

## üìÅ Estructura SIMPLIFICADA del Proyecto

```
üìÅ src/
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ karmatic/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ query-parser.ts      # Parser simple de queries
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ trust-engine.ts      # Motor de confianza anti-fraude
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ data-pipeline.ts     # Orquestador de APIs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ types.ts             # Tipos TypeScript
‚îÇ   ‚îú‚îÄ‚îÄ apis/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ google-places.ts     # Wrapper Google Places
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ apify-reviews.ts     # Wrapper Apify Scraper
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ perplexity.ts        # Wrapper Perplexity API
‚îÇ   ‚îî‚îÄ‚îÄ cache/
‚îÇ       ‚îî‚îÄ‚îÄ redis-client.ts       # Cache con Upstash
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îî‚îÄ‚îÄ api/
‚îÇ       ‚îî‚îÄ‚îÄ analyze/
‚îÇ           ‚îî‚îÄ‚îÄ route.ts          # Endpoint principal
‚îî‚îÄ‚îÄ components/
    ‚îî‚îÄ‚îÄ trust-score-card.tsx      # UI de resultados
```

## üîß Stack T√©cnico Simplificado

**APIs Externas:**
- Google Places API (datos b√°sicos, 5 reviews)
- Apify Google Maps Reviews Scraper (reviews completas)
- Perplexity API (an√°lisis inteligente)

**Infraestructura:**
- Next.js + TypeScript
- Upstash Redis (cache)
- Supabase (usuarios y analytics)
- Vercel (hosting)

**NO necesitamos:**
- Modelos ML propios
- Scrapers complejos
- Base de datos de agencias
- Agentes de Mastra (por ahora)

## üí° Ejemplo de Flujo Mejorado con Perplexity

```typescript
// Usuario: "Toyota Camry 2022 barato cerca de mi"

1. Query Parser:
   - Detecta: marca=Toyota, modelo=Camry, a√±o=2022, precio=econ√≥mico
   - NO FILTRA por marca Toyota (incluye todas las agencias)

2. Data Pipeline (paralelo):
   - Google Places: 30 agencias de autos cercanas (todas, no solo Toyota)
   - Apify Scraper: 500+ reviews por agencia top 10
   - Total tiempo: ~4s

3. Trust Engine:
   - Analiza reviews: fraude keywords, sentimiento, respuestas
   - Score: Agencia A (92%), Agencia B (85%), Agencia C (45%)
   
4. Perplexity Deep Analysis (para top agencias):
   Query: "Dame an√°lisis detallado de Autos del Valle ubicada en [direcci√≥n]. 
           Incluye: sitio web, inventario Toyota Camry, redes sociales, noticias recientes"
   
   Respuesta Perplexity:
   - URL inventario: autosdevalle.mx/inventario
   - Facebook: facebook.com/autosdelvalle (15K seguidores)
   - Tiene 3 Camry 2022 en stock
   - Noticia: "Premio mejor agencia 2023"

5. Response Enriquecida:
   ‚úÖ Autos del Valle - Multi-marca (92% confianza)
   - 4.8‚òÖ (523 reviews analizadas)
   - üì± facebook.com/autosdelvalle
   - üöó 3 Toyota Camry 2022 disponibles
   - "Premio mejor agencia 2023"
   - "Aunque no es agencia Toyota oficial, tiene excelente reputaci√≥n"
   
   ‚úÖ Toyota Centro - Agencia Oficial (85% confianza)
   - 4.5‚òÖ (312 reviews)
   - "Servicio oficial pero precios m√°s altos"
```

## üéØ Ventajas del Enfoque Mejorado

1. **Perplexity como "Swiss Army Knife"**:
   - An√°lisis profundo sin scrapers propios
   - Descubrimiento de URLs y redes sociales
   - Verificaci√≥n de inventario
   - B√∫squeda de noticias y premios

2. **Sin sesgo de marca**:
   - Incluye TODAS las agencias confiables
   - Mejor opci√≥n puede no ser la marca oficial
   - Usuario descubre opciones que no conoc√≠a

3. **Informaci√≥n enriquecida**:
   - No solo ratings, sino contexto completo
   - Enlaces directos a inventario
   - Presencia en redes sociales
   - Reconocimientos y noticias

4. **Costos optimizados**:
   - Perplexity solo para top agencias (no todas)
   - Cache agresivo de an√°lisis profundos
   - ROI alto por la calidad de informaci√≥n

## üîó Referencias

- Metodolog√≠a Perplexity original: [docs/projects/perplexity.md]
- Caso de uso automotriz: [docs/projects/caso-de-uso.md]
- APIs limitaciones: Investigaci√≥n actualizada en este documento